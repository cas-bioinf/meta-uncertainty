---
title: "MDS/PCoA"
output: html_notebook
---

TODO: jackknife beta diversity
Chao index
redundancy analysis, variance partition

Hellinger Distance, Chord Distance - great except for ignoring undersampling
Otherwise Jaccard, Sorensen, Ochiai


```{r setup}
library(tidyverse)
library(here)
library(vegan)
library(cowplot)
library(phyloseq)
library(rstan)
options(mc.cores = parallel::detectCores())
rstan_options(auto_write = TRUE)
source(here("R","sample_posterior.R"))

```

Tijana's code to load the data
```{r}
otutable = read.delim(file = here("private_data","tijana",'Seedlings_ITS2_otutab_ALL.csv'), sep = "\t") #reading the data I want to use
otutabP = otutable[, -1]
rownames(otutabP) = otutable [, 1]

t_otutab <- t(as.matrix(otutabP))

mapping = read.delim(file = here("private_data","tijana","Seedlings_ITS2_year1_mapping.csv"), sep = ",") %>%
  mutate(Replicate_no = gsub("[A-Za-z]","", Replicate), SoilSample = interaction(Soil, SampleType))
mapping2 = mapping [,-1] #it is the new mapping file with the proper row names, same as in previous case, here we added names from the mapping
rownames(mapping2) = mapping[,1]
#?order
mapping3 = sample_data(mapping2) #making corrected mapping file a phyloseq object

```

```{r}
plot_base_mds <- function(mds, mapping) {
  colnames(mds$points) <- c("MDS1","MDS2")
  mds$points %>% as.data.frame() %>% rownames_to_column("observation") %>% inner_join(mapping %>% mutate(Sample = as.character(Sample)), by =c("observation" = "Sample")) %>%
  ggplot(aes(MDS1, MDS2, color = SampleType, shape = Soil)) + geom_point(size = 2)  
}

plot_sampled_mds <- function(resampled_mds, mapping) {
  resampled_mds$points %>% as.data.frame() %>% set_names("MDS1","MDS2") %>% rownames_to_column("observation_sample") %>%
    separate("observation_sample", c("observation","sample"), sep = "_")  %>% 
    inner_join(mapping %>% mutate(Sample = as.character(Sample)), by =c("observation" = "Sample")) %>%
    mutate(is_original = sample == "Orig") %>%
    ggplot(aes(MDS1, MDS2, color = SampleType, shape = Soil, size = is_original, alpha = is_original)) + geom_point() + scale_size_manual(values = c(1, 3)) + scale_alpha_manual(values = c(0.3,1))
}
```


```{r}
set.seed(13248455)
min_depth = min(colSums(otutabP))
for(i in 1:10) {
  t_otus_rarefied = as.data.frame(round(rrarefy(t(otutabP), min_depth)))

  mds <- metaMDS(t_otus_rarefied)
  mds_plot <- plot_base_mds(mds, mapping)
  print(mds_plot)
}

```
```{r}
mds_rarefy <- metaMDS(flatten_posterior_samples(sample_posterior_rarefy(20, t_otutab)))
plot_sampled_mds(mds_rarefy, mapping)

```


```{r}
original_renamed <- t_otutab
rownames(original_renamed) <- paste0(rownames(original_renamed),"_","Orig")

mds_rarefy_with_orig <- metaMDS(rbind(original_renamed, flatten_posterior_samples(sample_posterior_rarefy(20, t_otutab))))
plot_sampled_mds(mds_rarefy_with_orig, mapping)
```


```{r}
set.seed(4822465)
for(i in 1:10) {
  t_otus_rarefied = as.data.frame(round(rrarefy(t(otutabP), min_depth)))

  dist <- vegdist(t_otus_rarefied) %>% sqrt() %>% wisconsin()
  classical_mds <- cmdscale(dist, add = TRUE, list. = TRUE)
  mds_plot <- plot_base_mds(classical_mds, mapping)
  print(mds_plot)
}


```


```{r}
set.seed(134524223)
#resampled_otu <- sample_posterior_dm_all(10, t_otutab, prior = 0.5, N_draws = "original") 
resampled_otu <- sample_posterior_dm_all(20, t_otutab, prior = "bayes", N_draws = "original")
resampled_otu_flat <- flatten_posterior_samples(resampled_otu)

resampled_mds <- metaMDS(rbind(original_renamed, resampled_otu_flat), trymax = 50)
```



```{r}
plot_sampled_mds(resampled_mds, mapping)
```

The same with ML prior
```{r}
set.seed(321485246)
#resampled_otu <- sample_posterior_dm_all(10, t_otutab, prior = 0.5, N_draws = "original") 
resampled_otu_ml <- sample_posterior_dm_all(20, t_otutab, prior = "ml", N_draws = "original")
resampled_otu_flat_ml <- flatten_posterior_samples(resampled_otu_ml)

resampled_mds_ml <- metaMDS(rbind(original_renamed, resampled_otu_flat_ml), trymax = 50)
plot_sampled_mds(resampled_mds_ml, mapping)
```

What happens when we take a small subset of the samples so that they are similar?

```{r}
selected_observations <- mapping %>% filter(SampleType == "Control", Soil == "Spruce") %>% pull("Sample") %>% as.character()

set.seed(1328454)
t_otutab_filtered <- t_otutab[selected_observations,, drop = FALSE]
resampled_otu_filtered <- sample_posterior_dm_all(20, t_otutab_filtered, prior = "bayes", N_draws = "original")
resampled_otu_filtered_flat <- flatten_posterior_samples(resampled_otu_filtered)
original_filtered_renamed <- t_otutab_filtered
rownames(original_filtered_renamed) <- paste0(rownames(original_filtered_renamed),"_","Orig")

set.seed(321452245)
#resampled_mds_filtered <- monoMDS(vegdist(rbind(original_filtered_renamed, resampled_otu_filtered_flat)))
resampled_mds_filtered <- metaMDS(rbind(original_filtered_renamed,resampled_otu_filtered_flat), trymax = 50)

```

```{r}
plot_sampled_mds(resampled_mds_filtered, mapping)
```

Testing DESeq2
```{r}
set.seed(321485246)
#resampled_otu <- sample_posterior_dm_all(10, t_otutab, prior = 0.5, N_draws = "original") 
resampled_otu_deseq <- sample_posterior_DESeq2(10, t_otutab,  mapping, ~SoilSample)
resampled_otu_flat_deseq <- flatten_posterior_samples(resampled_otu_deseq)

resampled_mds_deseq <- metaMDS(rbind(original_renamed, resampled_otu_flat_deseq), trymax = 50)
plot_sampled_mds(resampled_mds_deseq, mapping)
```

```{r}
dist_deseq <- vegdist(rbind(original_renamed, resampled_otu_flat_deseq)) %>% sqrt() %>% wisconsin()
classical_mds_deseq <- cmdscale(dist_deseq, add = TRUE, list. = TRUE)
plot_sampled_mds(classical_mds_deseq, mapping)
```
```{r}
set.seed(321485246)
#resampled_otu <- sample_posterior_dm_all(10, t_otutab, prior = 0.5, N_draws = "original") 
resampled_otu_deseq <- sample_posterior_DESeq2(20, t_otutab,  mapping, ~SoilSample)
resampled_otu_flat_deseq <- flatten_posterior_samples(resampled_otu_deseq)

resampled_mds_deseq <- metaMDS(rbind(original_renamed, resampled_otu_flat_deseq), trymax = 50)
plot_sampled_mds(resampled_mds_deseq, mapping)
```

DESEQ with each sample separate

```{r}
set.seed(13584224)
#resampled_otu <- sample_posterior_dm_all(10, t_otutab, prior = 0.5, N_draws = "original") 
mappingV2 <- mapping %>% mutate(Cat = Replicate_no < 3, SoilSampleCat = interaction(SoilSample,Cat))
resampled_otu_deseq_rep <- sample_posterior_DESeq2(20, t_otutab,  mappingV2, ~SoilSampleCat)
resampled_otu_flat_deseq_rep <- flatten_posterior_samples(resampled_otu_deseq_rep)

resampled_mds_deseq_rep <- metaMDS(rbind(original_renamed, resampled_otu_flat_deseq_rep), trymax = 50)
plot_sampled_mds(resampled_mds_deseq_rep, mapping)
```


```{r}
dist_deseq_rep <- vegdist(rbind(original_renamed, resampled_otu_flat_deseq_rep)) %>% sqrt() %>% wisconsin()
classical_mds_deseq_rep <- cmdscale(dist_deseq_rep, add = TRUE, list. = TRUE)
plot_sampled_mds(classical_mds_deseq_rep, mapping)
```

```{r}
xx <- sample_posterior_DESeq2(1, t_otutab, mapping, ~SoilSample)
plot(log(as.numeric(xx) + 0.5), log(as.numeric(t_otutab)+ 0.5))
abline(a = 0, b = 1)
```


```{r}
library(DESeq2)
dds <- DESeqDataSetFromMatrix(countData = otutabP, colData = mapping, design = ~SoilSample)
dds <- estimateSizeFactors(dds, type = "poscounts")
dds <- estimateDispersions(dds)
dds <- nbinomWaldTest(dds)

```

```{r}
n_otus <- ncol(t_otutab)
n_observations <- nrow(t_otutab)

predicted_means <- 2^(coef(dds) %*% t(model.matrix(~SoilSample, mapping ))) * matrix(rep(sizeFactors(dds), each = n_otus), n_otus, n_observations)
colnames(predicted_means) <- rownames(t_otutab)

```


```{r}
sName <- "TIJ019"
otherS <- paste0("TIJ0",20:23)

for(otu in sample(1:1034, 20)) {
  rand <- rnbinom(1000, mu = predicted_means[otu, sName], size = dispersions(dds)[otu])
  actual <- tibble(x = c(t_otutab[sName, otu], t_otutab[otherS, otu] / sizeFactors(dds)[otherS]))
  (tibble(x = rand) %>% ggplot(aes(x)) + geom_histogram(bins = 50) + geom_vline(data = actual, aes(xintercept = x)) )%>% print()
}
```

```{r}
fitted_quantiles <- pnbinom(t(t_otutab), mu = predicted_means, size = matrix(rep(dispersions(dds), times = n_observations), n_otus, n_observations))

fitted_quantiles_tidy <- fitted_quantiles %>% as.data.frame() %>% rownames_to_column("otu") %>% gather("observation","quantile", -otu) 

fitted_quantiles_tidy %>% filter(otu %in% sample(colnames(t_otutab), 20)) %>%
  ggplot(aes(x = quantile)) + geom_histogram(binwidth = 0.01) 

fitted_quantiles_tidy %>% filter(otu %in% sample(colnames(t_otutab), 20)) %>%
  ggplot(aes(x = quantile)) + geom_histogram(binwidth = 0.1) + facet_wrap(~otu)

fitted_quantiles_tidy %>% filter(observation %in% sample(rownames(t_otutab), 20)) %>%
  ggplot(aes(x = quantile)) + geom_histogram(binwidth = 0.1) + facet_wrap(~observation)

```


## Not working parts
Testing alternative priors, currently does not work

```{r}
set.seed(32146588)
#resampled_otu <- sample_posterior_dm_all(10, t_otutab, prior = 0.5, N_draws = "original") 
resampled_otu_2 <- sample_posterior_dm_all(20, t_otutab, prior = 0.5, N_draws = "original")
resampled_otu_flat_2 <- flatten_posterior_samples(resampled_otu)

resampled_mds_2 <- metaMDS(rbind(original_renamed, resampled_otu_flat_2), trymax = 50)
```
```{r}
plot_sampled_mds(resampled_mds_2, mapping)
```

Sampling in latent space

```{r}
set.seed(8524362)
resampled_latent <- sample_latent_dm_all(10, t_otutab, prior = 0.5) 
resampled_latent_flat <- flatten_posterior_samples(resampled_otu)

resampled_mds_latent <- metaMDS(resampled_otu_flat, trymax = 60)
```



```{r}
resampled_mds_latent$points %>% as.data.frame() %>% rownames_to_column("observation_sample") %>%
  separate("observation_sample", c("observation","sample"), sep = "_")  %>% 
  inner_join(mapping %>% mutate(Sample = as.character(Sample)), by =c("observation" = "Sample")) %>%
  ggplot(aes(MDS1, MDS2, color = SampleType, shape = Soil) + geom_point() 
```
